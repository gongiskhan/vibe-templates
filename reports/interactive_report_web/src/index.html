<!DOCTYPE html>
<html lang="pt" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Interactive Report</title>
  <link rel="stylesheet" href="./styles/tokens.css">
  <link rel="stylesheet" href="./styles/main.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <!-- Controls -->
  <div class="controls">
    <button id="locale-toggle">PT</button>
    <button id="theme-toggle">üåô</button>
  </div>

  <!-- Header -->
  <header class="report-header">
    <div class="header-content">
      <div class="report-title">
        <h1 data-i18n="report.title">Relat√≥rio de Vendas</h1>
        <p data-i18n="report.subtitle">An√°lise detalhada do per√≠odo selecionado</p>
      </div>
      <div class="header-actions">
        <button class="btn" onclick="exportCSV()">
          üìä <span data-i18n="actions.exportCSV">Exportar CSV</span>
        </button>
        <button class="btn" onclick="window.print()">
          üñ®Ô∏è <span data-i18n="actions.print">Imprimir</span>
        </button>
      </div>
    </div>
  </header>

  <!-- Filters -->
  <section class="filters-section">
    <div class="filters-container">
      <div class="filter-group">
        <label data-i18n="filters.startDate">Data Inicial</label>
        <input type="date" id="startDate" value="2024-01-01">
      </div>
      <div class="filter-group">
        <label data-i18n="filters.endDate">Data Final</label>
        <input type="date" id="endDate" value="2024-12-31">
      </div>
      <div class="filter-group">
        <label data-i18n="filters.category">Categoria</label>
        <select id="categoryFilter">
          <option value="" data-i18n="filters.all">Todos</option>
        </select>
      </div>
      <div class="filter-group">
        <label data-i18n="filters.status">Status</label>
        <select id="statusFilter">
          <option value="" data-i18n="filters.all">Todos</option>
        </select>
      </div>
      <button class="btn btn-primary" onclick="applyFilters()">
        <span data-i18n="filters.apply">Aplicar</span>
      </button>
    </div>
  </section>

  <!-- Main Content -->
  <main class="report-content">
    <!-- KPIs -->
    <div class="kpi-grid" id="kpi-grid"></div>

    <!-- Charts -->
    <div class="charts-grid">
      <div class="chart-card">
        <div class="chart-header">
          <h3 data-i18n="charts.revenueByMonth">Receita por M√™s</h3>
        </div>
        <div class="chart-container">
          <canvas id="revenueChart"></canvas>
        </div>
      </div>
      <div class="chart-card">
        <div class="chart-header">
          <h3 data-i18n="charts.salesByCategory">Vendas por Categoria</h3>
        </div>
        <div class="chart-container">
          <canvas id="categoryChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Data Table -->
    <div class="table-section">
      <div class="table-header">
        <h3 data-i18n="table.title">Detalhamento de Vendas</h3>
      </div>
      <table class="data-table">
        <thead>
          <tr>
            <th data-i18n="table.columns.id">ID</th>
            <th data-i18n="table.columns.date">Data</th>
            <th data-i18n="table.columns.customer">Cliente</th>
            <th data-i18n="table.columns.product">Produto</th>
            <th data-i18n="table.columns.category">Categoria</th>
            <th data-i18n="table.columns.quantity">Qtd</th>
            <th data-i18n="table.columns.value">Valor</th>
            <th data-i18n="table.columns.status">Status</th>
          </tr>
        </thead>
        <tbody id="data-table-body"></tbody>
      </table>
    </div>
  </main>

  <!-- Detail Modal -->
  <div class="modal-overlay" id="detail-modal">
    <div class="modal">
      <div class="modal-header">
        <h2 data-i18n="modal.title">Detalhes do Pedido</h2>
        <button class="modal-close" onclick="closeModal()">√ó</button>
      </div>
      <div class="modal-body" id="modal-content"></div>
    </div>
  </div>

  <script>
    // State
    let locale = localStorage.getItem('locale') || 'pt';
    let theme = localStorage.getItem('theme') || 'light';
    let translations = {};
    let salesData = [];
    let charts = {};

    // Sample data
    const generateData = () => {
      const categories = ['electronics', 'furniture', 'clothing', 'accessories'];
      const statuses = ['completed', 'pending', 'cancelled'];
      const customers = ['Jo√£o Silva', 'Maria Santos', 'Pedro Costa', 'Ana Oliveira', 'Carlos Souza'];
      const products = ['Laptop Pro', 'Cadeira Gamer', 'Camiseta B√°sica', 'Fone Bluetooth', 'Mesa de Escrit√≥rio', 'T√™nis Running'];

      const data = [];
      for (let i = 1; i <= 50; i++) {
        const date = new Date(2024, Math.floor(Math.random() * 12), Math.floor(Math.random() * 28) + 1);
        data.push({
          id: i,
          date: date.toISOString().split('T')[0],
          customer: customers[Math.floor(Math.random() * customers.length)],
          product: products[Math.floor(Math.random() * products.length)],
          category: categories[Math.floor(Math.random() * categories.length)],
          quantity: Math.floor(Math.random() * 10) + 1,
          value: Math.floor(Math.random() * 5000) + 100,
          status: statuses[Math.floor(Math.random() * statuses.length)]
        });
      }
      return data;
    };

    // Initialize
    async function init() {
      await loadTranslations();
      salesData = generateData();
      applyTheme();
      applyTranslations();
      populateFilters();
      renderKPIs();
      renderCharts();
      renderTable();
    }

    async function loadTranslations() {
      const ptRes = await fetch('./i18n/pt.json');
      const enRes = await fetch('./i18n/en.json');
      translations = { pt: await ptRes.json(), en: await enRes.json() };
    }

    function t(key) {
      const keys = key.split('.');
      let value = translations[locale];
      for (const k of keys) value = value?.[k];
      return value || key;
    }

    function applyTheme() {
      document.documentElement.setAttribute('data-theme', theme);
      document.getElementById('theme-toggle').textContent = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
    }

    function applyTranslations() {
      document.getElementById('locale-toggle').textContent = locale.toUpperCase();
      document.querySelectorAll('[data-i18n]').forEach(el => {
        el.textContent = t(el.getAttribute('data-i18n'));
      });
    }

    function populateFilters() {
      const categories = ['electronics', 'furniture', 'clothing', 'accessories'];
      const statuses = ['completed', 'pending', 'cancelled'];

      const catSelect = document.getElementById('categoryFilter');
      catSelect.innerHTML = `<option value="">${t('filters.all')}</option>` +
        categories.map(c => `<option value="${c}">${t('categories.' + c)}</option>`).join('');

      const statusSelect = document.getElementById('statusFilter');
      statusSelect.innerHTML = `<option value="">${t('filters.all')}</option>` +
        statuses.map(s => `<option value="${s}">${t('status.' + s)}</option>`).join('');
    }

    function getFilteredData() {
      const start = document.getElementById('startDate').value;
      const end = document.getElementById('endDate').value;
      const category = document.getElementById('categoryFilter').value;
      const status = document.getElementById('statusFilter').value;

      return salesData.filter(item => {
        if (start && item.date < start) return false;
        if (end && item.date > end) return false;
        if (category && item.category !== category) return false;
        if (status && item.status !== status) return false;
        return true;
      });
    }

    function renderKPIs() {
      const data = getFilteredData();
      const totalRevenue = data.reduce((sum, item) => sum + item.value, 0);
      const totalOrders = data.length;
      const avgTicket = totalOrders > 0 ? totalRevenue / totalOrders : 0;

      const kpis = [
        { key: 'totalRevenue', value: formatCurrency(totalRevenue), change: '+12.5%', positive: true },
        { key: 'totalOrders', value: totalOrders.toString(), change: '+8.2%', positive: true },
        { key: 'averageTicket', value: formatCurrency(avgTicket), change: '+3.1%', positive: true },
        { key: 'conversionRate', value: '4.2%', change: '-0.5%', positive: false }
      ];

      document.getElementById('kpi-grid').innerHTML = kpis.map(kpi => `
        <div class="kpi-card">
          <h3>${t('kpis.' + kpi.key)}</h3>
          <div class="kpi-value">${kpi.value}</div>
          <div class="kpi-change ${kpi.positive ? 'positive' : 'negative'}">
            ${kpi.change} ${t('kpis.vsLastPeriod')}
          </div>
        </div>
      `).join('');
    }

    function renderCharts() {
      const data = getFilteredData();
      const chartColors = ['#6366f1', '#06b6d4', '#10b981', '#f59e0b', '#ec4899', '#8b5cf6'];

      // Destroy existing charts
      Object.values(charts).forEach(chart => chart.destroy());

      // Revenue by Month
      const monthlyData = {};
      data.forEach(item => {
        const month = item.date.substring(0, 7);
        monthlyData[month] = (monthlyData[month] || 0) + item.value;
      });

      const sortedMonths = Object.keys(monthlyData).sort();
      charts.revenue = new Chart(document.getElementById('revenueChart'), {
        type: 'line',
        data: {
          labels: sortedMonths,
          datasets: [{
            label: t('kpis.totalRevenue'),
            data: sortedMonths.map(m => monthlyData[m]),
            borderColor: chartColors[0],
            backgroundColor: chartColors[0] + '20',
            fill: true,
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } }
        }
      });

      // Sales by Category
      const categoryData = {};
      data.forEach(item => {
        categoryData[item.category] = (categoryData[item.category] || 0) + item.value;
      });

      charts.category = new Chart(document.getElementById('categoryChart'), {
        type: 'doughnut',
        data: {
          labels: Object.keys(categoryData).map(c => t('categories.' + c)),
          datasets: [{
            data: Object.values(categoryData),
            backgroundColor: chartColors
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false
        }
      });
    }

    function renderTable() {
      const data = getFilteredData();
      document.getElementById('data-table-body').innerHTML = data.slice(0, 20).map(item => `
        <tr onclick="showDetail(${item.id})">
          <td>${item.id}</td>
          <td>${formatDate(item.date)}</td>
          <td>${item.customer}</td>
          <td>${item.product}</td>
          <td>${t('categories.' + item.category)}</td>
          <td>${item.quantity}</td>
          <td>${formatCurrency(item.value)}</td>
          <td><span class="badge badge-${getStatusClass(item.status)}">${t('status.' + item.status)}</span></td>
        </tr>
      `).join('');
    }

    function showDetail(id) {
      const item = salesData.find(i => i.id === id);
      if (!item) return;

      document.getElementById('modal-content').innerHTML = `
        <div class="detail-row"><span class="detail-label">ID</span><span class="detail-value">${item.id}</span></div>
        <div class="detail-row"><span class="detail-label">${t('table.columns.date')}</span><span class="detail-value">${formatDate(item.date)}</span></div>
        <div class="detail-row"><span class="detail-label">${t('table.columns.customer')}</span><span class="detail-value">${item.customer}</span></div>
        <div class="detail-row"><span class="detail-label">${t('table.columns.product')}</span><span class="detail-value">${item.product}</span></div>
        <div class="detail-row"><span class="detail-label">${t('table.columns.category')}</span><span class="detail-value">${t('categories.' + item.category)}</span></div>
        <div class="detail-row"><span class="detail-label">${t('table.columns.quantity')}</span><span class="detail-value">${item.quantity}</span></div>
        <div class="detail-row"><span class="detail-label">${t('table.columns.value')}</span><span class="detail-value">${formatCurrency(item.value)}</span></div>
        <div class="detail-row"><span class="detail-label">${t('table.columns.status')}</span><span class="detail-value"><span class="badge badge-${getStatusClass(item.status)}">${t('status.' + item.status)}</span></span></div>
      `;
      document.getElementById('detail-modal').classList.add('active');
    }

    function closeModal() {
      document.getElementById('detail-modal').classList.remove('active');
    }

    function applyFilters() {
      renderKPIs();
      renderCharts();
      renderTable();
    }

    function exportCSV() {
      const data = getFilteredData();
      const headers = ['ID', 'Date', 'Customer', 'Product', 'Category', 'Quantity', 'Value', 'Status'];
      const csv = [headers.join(','), ...data.map(item =>
        [item.id, item.date, item.customer, item.product, item.category, item.quantity, item.value, item.status].join(',')
      )].join('\n');

      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'report.csv';
      a.click();
    }

    function formatCurrency(value) {
      return new Intl.NumberFormat(locale === 'pt' ? 'pt-BR' : 'en-US', {
        style: 'currency',
        currency: locale === 'pt' ? 'BRL' : 'USD'
      }).format(value);
    }

    function formatDate(date) {
      return new Date(date).toLocaleDateString(locale === 'pt' ? 'pt-BR' : 'en-US');
    }

    function getStatusClass(status) {
      return { completed: 'success', pending: 'warning', cancelled: 'error' }[status] || 'default';
    }

    // Event listeners
    document.getElementById('theme-toggle').addEventListener('click', () => {
      theme = theme === 'dark' ? 'light' : 'dark';
      localStorage.setItem('theme', theme);
      applyTheme();
    });

    document.getElementById('locale-toggle').addEventListener('click', () => {
      locale = locale === 'pt' ? 'en' : 'pt';
      localStorage.setItem('locale', locale);
      applyTranslations();
      populateFilters();
      renderKPIs();
      renderCharts();
      renderTable();
    });

    document.getElementById('detail-modal').addEventListener('click', (e) => {
      if (e.target === document.getElementById('detail-modal')) closeModal();
    });

    init();
  </script>
</body>
</html>
